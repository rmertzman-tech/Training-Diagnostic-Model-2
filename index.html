<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 2: Diagnostic Practice (Enhanced)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slider-container input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .score-bar {
            height: 24px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .nav-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .menu-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            min-width: 250px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-document, #printable-document * {
                visibility: visible;
            }
            #printable-document {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .nav-menu {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Utility Functions
        const generateSessionId = () => {
            const date = new Date();
            const dateStr = date.toISOString().slice(0,10).replace(/-/g, '');
            const timeStr = date.toTimeString().slice(0,5).replace(/:/g, '');
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `M2-${dateStr}-${timeStr}-${random}`;
        };

        const calculateAccuracy = (studentScores, expertScores) => {
            const capacityDiff = Math.abs(studentScores.capacity - expertScores.capacity);
            const capabilityDiff = Math.abs(studentScores.capability - expertScores.capability);
            const constructorDiff = Math.abs(studentScores.constructor - expertScores.constructor);
            const metaConstructorDiff = Math.abs(studentScores.metaConstructor - expertScores.metaConstructor);
            
            const avgDiff = (capacityDiff + capabilityDiff + constructorDiff + metaConstructorDiff) / 4;
            let accuracy = Math.max(0, 100 - avgDiff);
            
            if (studentScores.primary === expertScores.primary) {
                accuracy = Math.min(100, accuracy + 10);
            }
            
            return Math.round(accuracy);
        };

        const determineSkillLevel = (accuracy) => {
            if (accuracy >= 85) return 'Proficient';
            if (accuracy >= 70) return 'Developing';
            return 'Novice';
        };

        // Storage management
        const loadProgress = () => {
            const saved = localStorage.getItem('module2ProgressEnhanced');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                completions: [], // Array of completed sessions
                currentSession: null // In-progress session
            };
        };

        const saveProgress = (data) => {
            localStorage.setItem('module2ProgressEnhanced', JSON.stringify(data));
        };

        const clearAllProgress = () => {
            if (confirm('This will delete ALL your saved work and completions. Are you sure?')) {
                localStorage.removeItem('module2ProgressEnhanced');
                window.location.reload();
            }
        };

        // Expert Diagnoses Data (same as before)
        const EXPERT_DIAGNOSES = {
            case1: {
                capacity: 85,
                capability: 15,
                constructor: 30,
                metaConstructor: 20,
                primary: 'capacity',
                explanation: 'This is primarily a capacity suppression problem. The nurses clearly have the capacity for compassion (they entered the field because of it and show empathy with family), but chronic stress, impossible workloads, and constant exposure to suffering are preventing expression of this capacity. The biological substrates are being degraded by chronic stress (Sapolsky). This is NOT a capability gap - they know how to be compassionate. It\'s that the context is overwhelming their ability to express it.',
                commonMistake: 'Students often misdiagnose this as a capability gap (need more training in compassion). But notice they USED to perform well and still show compassion outside work - that indicates capacity exists but is suppressed by context.'
            },
            case2: {
                capacity: 20,
                capability: 80,
                constructor: 30,
                metaConstructor: 15,
                primary: 'capability',
                explanation: 'This is a capability gap problem. People have the capacity for ethical reasoning and want to do the right thing, but lack reliable protocols and procedures for actually implementing ethics in their specific roles. Teaching abstract principles doesn\'t help because the problem isn\'t values - it\'s the absence of clear, practiced, reliable methods for ethical action in context. They need capability development: clear specifications, practiced procedures, and reliable patterns of coordination.',
                commonMistake: 'Students sometimes think this is a constructor problem (need to institutionalize). But you can\'t institutionalize what doesn\'t exist yet - first you need to develop the capabilities, THEN institutionalize them.'
            },
            case3: {
                capacity: 25,
                capability: 40,
                constructor: 85,
                metaConstructor: 20,
                primary: 'constructor',
                explanation: 'This is a constructor failure. The ethical practices were working but depended entirely on the founder\'s personal presence rather than being institutionalized in structures, rituals, and norms that persist across personnel changes. When the founder left, the knowledge and practices left too. This shows the patterns were never properly built into persistent constructors - they were capability-level (worked when the founder used them) but never became constructor-level (work automatically and persist).',
                commonMistake: 'Students might think this is capacity suppression (people lost motivation). But the issue is that practices weren\'t institutionalized - they need to rebuild constructors that don\'t depend on any individual.'
            },
            case4: {
                capacity: 30,
                capability: 35,
                constructor: 40,
                metaConstructor: 85,
                primary: 'metaConstructor',
                explanation: 'This is a meta-constructor absence problem. The policy is causing clear harm but there\'s no mechanism to examine, challenge, or revise it. The system cannot learn from mistakes or adapt to new information. This is the absence of meta-constructor capacity at the institutional level - no review mechanisms, no sunset clauses, no safe channels for challenge, no learning loops. The system is locked in and cannot improve itself.',
                commonMistake: 'Students might focus on the bad policy content (a capability problem). But the deeper issue is that there\'s no way to FIX bad policies when discovered - that\'s the meta-constructor problem.'
            },
            case5: {
                capacity: 70,
                capability: 60,
                constructor: 40,
                metaConstructor: 30,
                primary: 'capacity',
                explanation: 'This is a multi-level problem requiring integrated intervention. PRIMARY: Capacity suppression - students are chronically stressed, sleep-deprived, and overloaded, which degrades their ability to learn and make good decisions. SECONDARY: Capability gap - many lack effective study skills and time management. TERTIARY: Constructor failure - a culture of cheating has normalized unethical behavior. Must address all levels, but start with capacity (reduce stressors, provide support) while simultaneously building capabilities and changing culture.',
                commonMistake: 'Students often jump to "it\'s the culture" (constructor) and miss that stressed, desperate students with poor study skills are being pushed toward cheating by impossible circumstances. Must address context first.'
            },
            case6: {
                capacity: 50,
                capability: 55,
                constructor: 65,
                metaConstructor: 45,
                primary: 'various',
                explanation: 'This ambiguous case has multiple reasonable interpretations. Is the family\'s capacity being suppressed by their beliefs, or do they have different but equally valid values? Is this a capability gap (they don\'t understand medical facts) or a genuine value difference? Reasonable people can disagree. Key insight: Sometimes diagnostic uncertainty means we need MORE INFORMATION before intervening. Humility about our ability to diagnose others\' capacity, especially across cultural/religious differences, is essential. Whatever your diagnosis, you must defend it with evidence and acknowledge uncertainty.',
                commonMistake: 'Rushing to judgment without acknowledging legitimate ambiguity and the need for more information, especially in cross-cultural contexts.'
            }
        };

        // Cases Data (same as before, keeping it compact)
        const CASES = [
            {
                id: 'case1',
                title: 'The Burned-Out Nurses',
                difficulty: 1,
                domain: 'Healthcare',
                scenario: `St. Mary's Hospital has been experiencing a troubling pattern over the past 18 months. Nurses who were once known for their compassionate care are increasingly showing signs of emotional detachment. Patients complain about curt responses and lack of empathy. Family members report nurses seeming "checked out" or irritable.

However, when you look at individual nurses' backgrounds, they all entered healthcare because of genuine compassion. They volunteer in their communities. They show deep empathy with their own families. Some were voted "most compassionate" just a few years ago.

The context: The hospital has been chronically understaffed due to budget cuts. Nurses regularly work 12-14 hour shifts with minimal breaks. They're required to care for 8-10 patients each when best practice recommends 4-5. Many report having no time to properly care for patients - having to rush through basic needs. Moral injury is common: knowing what patients need but being unable to provide it. Staff meetings have been cancelled. There's constant exposure to suffering and death without time for processing.`,
                stakeholders: 'Nurses (burned out), Patients (receiving substandard care), Hospital administrators (budget constraints), Families (concerned)',
                context: 'Chronic understaffing, impossible workloads, budget cuts, no processing time, moral injury',
                problem: 'Previously compassionate nurses showing reduced empathy and care quality',
                question: 'What level is the primary problem, and what type of intervention is needed?'
            },
            {
                id: 'case2',
                title: 'The Ethics Training Failure',
                difficulty: 1,
                domain: 'Business',
                scenario: `TechCorp brought in expensive ethics consultants to address concerning behavior: favoritism in promotions, inconsistent standards, occasional harassment going unaddressed. The consultants provided comprehensive training on ethical principles, values, and moral philosophy. Everyone completed the training. Exit surveys showed people found it "inspiring" and felt motivated to "do better."

Three months later, nothing has changed. The same problems persist. When you interview employees, they say things like: "I want to be fair, but how do I actually decide between candidates when both are qualified?" "I know harassment is wrong, but what specifically do I say when I witness it?" "The values are great but there's no clear process for applying them."

The context: TechCorp has vague policies that say things like "be ethical" and "treat people fairly" but no clear protocols for specific situations. There's no standardized interview process, no clear guidelines for addressing harassment, no consistent performance evaluation criteria. Managers are left to "use their judgment" with no training in how to implement that judgment reliably.`,
                stakeholders: 'Employees (want to do right but unsure how), Managers (lack clear protocols), Ethics consultants (taught principles, not practices)',
                context: 'Vague policies, no clear protocols, no standardized processes, "use your judgment" without guidance',
                problem: 'Ethics training doesn\'t translate to behavior change',
                question: 'Why didn\'t the ethics training work, and what\'s actually needed?'
            },
            {
                id: 'case3',
                title: 'When the Founder Leaves',
                difficulty: 1,
                domain: 'Organizational',
                scenario: `GreenFuture, a sustainable business consultancy, was founded by Maya Chen, a charismatic leader deeply committed to both environmental and social ethics. Under her leadership, the company had an outstanding reputation. They turned down lucrative contracts if clients wouldn't commit to genuine sustainability. Employees felt empowered to raise ethical concerns. Regular meetings addressed dilemmas thoughtfully.

Maya was the person everyone went to with questions. She personally modeled ethical decision-making. She told stories that conveyed the company's values. She made final calls on difficult trade-offs. When she announced her retirement, everyone was nervous but assumed her deputy would maintain the culture.

Within six months of Maya's departure, things fell apart. The deputy didn't have Maya's moral clarity. Without her stories and personal example, people lost confidence in their own judgment. The regular ethics meetings stopped (Maya had organized them). Employees started taking contracts they wouldn't have before. Several top performers left, saying "it's not the same company."

The context: All of GreenFuture's ethical practices lived in Maya's head and personal habits. Nothing was written down. There were no institutionalized procedures. No training program. No documented decision-making frameworks. Everything depended on Maya being there.`,
                stakeholders: 'Maya (retired founder), Deputy (can\'t replicate Maya), Employees (lost without founder), Clients (noticing changes)',
                context: 'Everything depended on founder, no documentation, no institutionalized practices, no training program',
                problem: 'Ethical practices collapsed when founder left',
                question: 'What was the structural problem, and what should have been done differently?'
            },
            {
                id: 'case4',
                title: 'The Unchangeable Policy',
                difficulty: 1,
                domain: 'Policy',
                scenario: `The Department of Education implemented a "zero tolerance" policy for student discipline 15 years ago. Any student who gets in a physical altercation is automatically suspended for 10 days, no exceptions. At the time, this seemed to address concerns about inconsistent discipline and favoritism.

However, the policy has clearly caused harm. Students defending themselves from bullies are suspended equally with aggressors. Students with disabilities who have behavior episodes are suspended at high rates. Victims of assault who push their attacker away are punished the same as the attacker. Research shows these suspensions don't improve safety and significantly harm suspended students' academic outcomes.

Teachers, principals, and even school board members acknowledge the policy is causing harm. Everyone knows it should be revised to allow for context, self-defense, and disability accommodations. But the policy is locked in. It would require state legislative action to change, and no legislator wants to be seen as "soft on discipline." There's no built-in review process. No sunset clause. No mechanism for schools to request exemptions or modifications. The department has no authority to revise it even when presented with evidence of harm.

The context: Policy is state law, requires legislature to change, political barriers to revision, no review mechanism, no sunset clause, no exemption process, no learning built in.`,
                stakeholders: 'Students (being harmed), Teachers/Principals (hands tied), School board (no authority to change), Legislators (politically difficult), Parents (frustrated)',
                context: 'State law, requires legislature, political barriers, no review process, no sunset clause, locked in',
                problem: 'Clearly harmful policy cannot be examined or revised',
                question: 'What systemic problem does this illustrate, and what structural changes would prevent it?'
            },
            {
                id: 'case5',
                title: 'The Cheating Epidemic',
                difficulty: 2,
                domain: 'Education',
                scenario: `Riverside University has discovered widespread cheating. In a recent engineering exam, 40% of students were found to have used unauthorized materials. This follows patterns of cheating in other departments. When the honor code was introduced 10 years ago, violations were rare. Now they're endemic.

Investigation reveals multiple factors: (1) Students are overwhelmed - taking 18+ credits, working 20+ hours/week to afford tuition, sleeping 4-5 hours/night. Many report feeling desperate and unable to keep up. (2) Many students never learned effective study skills - they're trying but don't know HOW to learn the material in the time available. High school didn't prepare them. (3) A culture of cheating has developed - "everyone does it," sharing test banks is normalized, and students who don't cheat feel like "suckers." (4) Class sizes have tripled while instructors decreased - students feel anonymous and have no relationship with professors.

The context: Tuition increases forcing students to work more, class sizes increased, support services cut, high school preparation inadequate, culture of cheating normalized, sleep deprivation and stress endemic, weak study skills widespread.`,
                stakeholders: 'Students (stressed, desperate, some lacking skills), Faculty (overwhelmed, disappointed), Administration (budget pressures), Parents (concerned)',
                context: 'Multiple stressors, financial pressure, inadequate preparation, normalized cheating, large classes, minimal support',
                problem: 'Widespread cheating in previously honest environment',
                question: 'This is a multi-level problem. Identify all the levels involved and recommend an integrated intervention strategy.'
            },
            {
                id: 'case6',
                title: 'Cultural Conflict in Healthcare (Ambiguous Case)',
                difficulty: 3,
                domain: 'Healthcare',
                scenario: `Dr. Sarah Johnson is treating 8-year-old Emma, who has a treatable but serious bacterial infection. Without antibiotics, Emma will likely suffer serious complications, possibly including permanent hearing loss or, in worst case, death. With antibiotics, full recovery is expected.

Emma's parents are devout members of a religious community that rejects modern medicine, relying instead on prayer and natural remedies. They are loving, educated parents who are deeply committed to Emma's wellbeing as they understand it. They believe that accepting medical treatment shows lack of faith in God and could harm Emma spiritually, which they see as far more important than physical health.

The parents explain their worldview articulately. They cite examples of community members who recovered through faith. They're not ignorant of medical science - they consciously reject it based on deeply held theological beliefs. They argue that religious freedom includes the right to make medical decisions for their children according to their faith.

Dr. Johnson believes Emma's physical wellbeing must be prioritized and is considering seeking a court order to treat against parental wishes. She worries that the parents' capacity for rational decision-making is being constrained by their religious indoctrination. But she also wonders: Is she being paternalistic? Are the parents demonstrating different but valid values? Does medical authority override religious freedom?

The context: Religious beliefs vs. medical judgment, child cannot consent, serious harm likely without treatment, loving but religiously committed parents, questions of capacity vs. values, cultural/religious difference.`,
                stakeholders: 'Emma (child at risk), Parents (religious commitment), Dr. Johnson (medical responsibility), Religious community, Legal system',
                context: 'Religious beliefs, medical necessity, parental rights, child welfare, cultural difference, capacity vs. values questions',
                problem: 'Conflict between religious freedom and child welfare',
                question: 'This is deliberately ambiguous. How do you diagnose the levels involved? Is this capacity suppression, value difference, or something else? Defend your diagnosis while acknowledging uncertainty.'
            }
        ];

        // Pattern Recognition Questions (same as before)
        const PATTERN_QUESTIONS = [
            {
                id: 'pr1',
                scenario: 'A teacher who has always been excellent suddenly starts arriving late and seems disengaged. Investigation reveals a new policy requiring 3 hours of daily administrative paperwork, leaving no time for lesson planning.',
                correctAnswer: 'capacity',
                explanation: 'This is capacity suppression. The teacher has demonstrated capacity (past excellence) but new stressors (excessive bureaucracy) are preventing its expression.'
            },
            {
                id: 'pr2',
                scenario: 'A hospital has a great ethics policy written by the former director. After she left, no one follows it because no one else knows how to implement it in practice.',
                correctAnswer: 'constructor',
                explanation: 'This is constructor failure. The policy existed but wasn\'t institutionalized - it depended on one person rather than being built into persistent structures.'
            },
            {
                id: 'pr3',
                scenario: 'Employees want to be inclusive but don\'t know how to run meetings that accommodate different communication styles. They need specific techniques.',
                correctAnswer: 'capability',
                explanation: 'This is a capability gap. They have the capacity (desire to be inclusive) but lack reliable methods and practiced techniques for achieving it.'
            },
            {
                id: 'pr4',
                scenario: 'A company discovers its AI hiring system is biased. There\'s no process to audit it, no mechanism to receive complaints about it, and no authority to revise it without executive approval (which takes months).',
                correctAnswer: 'metaConstructor',
                explanation: 'This is meta-constructor absence. The system cannot examine or improve itself - no audit mechanisms, feedback loops, or revision authority.'
            },
            {
                id: 'pr5',
                scenario: 'A prison guard who has shown compassion for decades becomes increasingly harsh after being assaulted by an inmate. She now sees all inmates as threats.',
                correctAnswer: 'capacity',
                explanation: 'This is capacity suppression. The trauma (assault) has activated threat-detection systems that now override her capacity for compassion. The capacity existed before and could return with support.'
            },
            {
                id: 'pr6',
                scenario: 'A university has a peer review process that catches problems before they escalate. When leadership changes and the new dean eliminates it to save money, small issues grow into major scandals.',
                correctAnswer: 'metaConstructor',
                explanation: 'This is meta-constructor capacity. The peer review was a learning mechanism - it allowed the system to catch and correct problems. Removing it eliminated the ability to self-improve.'
            },
            {
                id: 'pr7',
                scenario: 'Nurses know the importance of hand hygiene but forget to wash hands consistently during busy shifts. They need a systematic protocol that works under pressure.',
                correctAnswer: 'capability',
                explanation: 'This is capability gap. They have capacity (knowledge) but lack reliable performance under real conditions. Need capability development - practiced procedures that work in context.'
            },
            {
                id: 'pr8',
                scenario: 'A nonprofit\'s conflict resolution practices work great when the founder mediates, but fall apart when anyone else tries. The practices aren\'t documented or trained.',
                correctAnswer: 'constructor',
                explanation: 'Constructor failure. Practices exist at capability level (work when founder does them) but haven\'t been institutionalized into persistent structures independent of individuals.'
            },
            {
                id: 'pr9',
                scenario: 'A city discovers its zoning laws from the 1950s now segregate communities and restrict affordable housing, but they\'re enshrined in the city charter with no amendment process.',
                correctAnswer: 'metaConstructor',
                explanation: 'Meta-constructor absence. The system is locked and cannot learn from its mistakes or adapt to new understanding - no revision mechanisms.'
            },
            {
                id: 'pr10',
                scenario: 'Customer service representatives used to be empathetic but have become robotic after the company installed monitoring software that penalizes any call over 3 minutes.',
                correctAnswer: 'capacity',
                explanation: 'Capacity suppression. The monitoring creates stress and removes autonomy, suppressing their existing capacity for empathy. They CAN be empathetic (did before) but context prevents it.'
            }
        ];

        // Navigation Menu Component (NEW)
        function NavigationMenu({ stage, progressData, onAction }) {
            const [isOpen, setIsOpen] = useState(false);
            const hasCompletions = progressData.completions && progressData.completions.length > 0;
            const hasCurrentSession = progressData.currentSession !== null;

            return (
                <div className="nav-menu">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="bg-white hover:bg-gray-50 text-gray-700 p-3 rounded-lg shadow-lg transition-colors"
                        title="Menu"
                    >
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>

                    {isOpen && (
                        <div className="menu-dropdown bg-white rounded-lg shadow-2xl border border-gray-200">
                            <div className="p-4 border-b border-gray-200">
                                <h3 className="font-bold text-gray-900">Menu</h3>
                            </div>
                            
                            <div className="p-2">
                                {hasCompletions && (
                                    <button
                                        onClick={() => { onAction('viewCompletions'); setIsOpen(false); }}
                                        className="w-full text-left px-4 py-3 hover:bg-purple-50 rounded flex items-center space-x-2 text-gray-700"
                                    >
                                        <span>üìã</span>
                                        <span>Review Completed Work</span>
                                        <span className="ml-auto bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full">
                                            {progressData.completions.length}
                                        </span>
                                    </button>
                                )}

                                {stage !== 'welcome' && stage !== 'review' && (
                                    <button
                                        onClick={() => { 
                                            if (confirm('Start a new session? Current progress will be saved.')) {
                                                onAction('startNew'); 
                                                setIsOpen(false);
                                            }
                                        }}
                                        className="w-full text-left px-4 py-3 hover:bg-blue-50 rounded flex items-center space-x-2 text-gray-700"
                                    >
                                        <span>üîÑ</span>
                                        <span>Start New Session</span>
                                    </button>
                                )}

                                {(hasCompletions || hasCurrentSession) && (
                                    <button
                                        onClick={() => { clearAllProgress(); setIsOpen(false); }}
                                        className="w-full text-left px-4 py-3 hover:bg-red-50 rounded flex items-center space-x-2 text-red-600"
                                    >
                                        <span>üóëÔ∏è</span>
                                        <span>Clear All Data</span>
                                    </button>
                                )}

                                <div className="border-t border-gray-200 my-2"></div>

                                <button
                                    onClick={() => setIsOpen(false)}
                                    className="w-full text-left px-4 py-3 hover:bg-gray-50 rounded flex items-center space-x-2 text-gray-500"
                                >
                                    <span>‚úï</span>
                                    <span>Close Menu</span>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Main App Component (UPDATED)
        function App() {
            const [stage, setStage] = useState('welcome'); // welcome, tutorial, responsibility, cases, pattern, complete, review, viewCompletions
            const [progressData, setProgressData] = useState(loadProgress());
            const [studentInfo, setStudentInfo] = useState({ name: '', email: '', course: '' });
            const [currentCaseIndex, setCurrentCaseIndex] = useState(0);
            const [reviewingCompletion, setReviewingCompletion] = useState(null);

            // Save progress whenever it changes
            useEffect(() => {
                saveProgress(progressData);
            }, [progressData]);

            const startNewSession = (info) => {
                const sessionId = generateSessionId();
                const newSession = {
                    sessionId,
                    studentInfo: info,
                    startTime: new Date().toISOString(),
                    completionTime: null,
                    cases: [],
                    patternRecognition: { answers: [], score: 0 }
                };
                
                setStudentInfo(info);
                setProgressData({
                    ...progressData,
                    currentSession: newSession
                });
                setStage('tutorial');
            };

            const continueSession = () => {
                if (progressData.currentSession) {
                    setStudentInfo(progressData.currentSession.studentInfo);
                    // Determine where to continue
                    if (progressData.currentSession.cases.length === 0) {
                        setStage('tutorial');
                    } else if (progressData.currentSession.cases.length < CASES.length) {
                        setCurrentCaseIndex(progressData.currentSession.cases.length);
                        setStage('cases');
                    } else if (!progressData.currentSession.patternRecognition.answers.length) {
                        setStage('pattern');
                    } else {
                        setStage('complete');
                    }
                }
            };

            const completeCaseWork = (caseData) => {
                const updatedSession = {
                    ...progressData.currentSession,
                    cases: [...progressData.currentSession.cases, caseData]
                };
                
                setProgressData({
                    ...progressData,
                    currentSession: updatedSession
                });

                if (currentCaseIndex < CASES.length - 1) {
                    setCurrentCaseIndex(currentCaseIndex + 1);
                } else {
                    setStage('pattern');
                }
            };

            const completePatternRecognition = (results) => {
                const completedSession = {
                    ...progressData.currentSession,
                    patternRecognition: results,
                    completionTime: new Date().toISOString()
                };

                // Move to completions array
                setProgressData({
                    completions: [...progressData.completions, completedSession],
                    currentSession: null
                });
                
                setStage('complete');
            };

            const handleMenuAction = (action) => {
                switch(action) {
                    case 'viewCompletions':
                        setStage('viewCompletions');
                        break;
                    case 'startNew':
                        setStage('welcome');
                        setCurrentCaseIndex(0);
                        break;
                }
            };

            const reviewCompletion = (completion) => {
                setReviewingCompletion(completion);
                setStage('review');
            };

            return (
                <div className="min-h-screen">
                    {/* Navigation Menu - Always Visible */}
                    <NavigationMenu 
                        stage={stage}
                        progressData={progressData}
                        onAction={handleMenuAction}
                    />

                    <header className="gradient-bg text-white shadow-lg">
                        <div className="max-w-5xl mx-auto px-4 py-6">
                            <h1 className="text-3xl font-bold mb-2">Module 2: Diagnostic Practice</h1>
                            <p className="text-lg opacity-90">Learn to diagnose ethical problems at the right level</p>
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto px-4 py-8">
                        {stage === 'welcome' && (
                            <WelcomeScreen 
                                onStart={startNewSession}
                                onContinue={continueSession}
                                progressData={progressData}
                                onReview={() => setStage('viewCompletions')}
                            />
                        )}
                        {stage === 'tutorial' && (
                            <TutorialScreen onComplete={() => setStage('responsibility')} />
                        )}
                        {stage === 'responsibility' && (
                            <ResponsibilityScreen onComplete={() => setStage('cases')} />
                        )}
                        {stage === 'cases' && (
                            <CaseWorkflow 
                                caseData={CASES[currentCaseIndex]}
                                caseNumber={currentCaseIndex + 1}
                                totalCases={CASES.length}
                                onComplete={completeCaseWork}
                            />
                        )}
                        {stage === 'pattern' && (
                            <PatternRecognitionGame 
                                questions={PATTERN_QUESTIONS}
                                onComplete={completePatternRecognition}
                            />
                        )}
                        {stage === 'complete' && (
                            <CompletionScreen 
                                completion={progressData.completions[progressData.completions.length - 1]}
                                onStartNew={() => setStage('welcome')}
                                onReview={() => reviewCompletion(progressData.completions[progressData.completions.length - 1])}
                            />
                        )}
                        {stage === 'viewCompletions' && (
                            <CompletionsListScreen 
                                completions={progressData.completions}
                                onSelectCompletion={reviewCompletion}
                                onBack={() => setStage('welcome')}
                            />
                        )}
                        {stage === 'review' && (
                            <ReviewMode 
                                completion={reviewingCompletion}
                                onBack={() => setStage('viewCompletions')}
                            />
                        )}
                    </main>
                </div>
            );
        }

        // Welcome Screen (UPDATED)
        function WelcomeScreen({ onStart, onContinue, progressData, onReview }) {
            const [formData, setFormData] = useState({ name: '', email: '', course: '' });
            const hasCurrentSession = progressData.currentSession !== null;
            const hasCompletions = progressData.completions && progressData.completions.length > 0;

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.name && formData.email && formData.course) {
                    onStart(formData);
                }
            };

            return (
                <div className="fade-in max-w-2xl mx-auto space-y-6">
                    {/* Show saved progress if exists */}
                    {(hasCurrentSession || hasCompletions) && (
                        <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                            <h3 className="text-xl font-bold text-blue-900 mb-4">üìÇ Saved Progress Found</h3>
                            
                            {hasCurrentSession && (
                                <div className="bg-white p-4 rounded-lg mb-4">
                                    <h4 className="font-semibold text-gray-900 mb-2">In-Progress Session</h4>
                                    <p className="text-gray-700 mb-2">
                                        {progressData.currentSession.studentInfo.name}
                                    </p>
                                    <p className="text-sm text-gray-600 mb-3">
                                        Cases completed: {progressData.currentSession.cases.length}/{CASES.length}
                                    </p>
                                    <button
                                        onClick={onContinue}
                                        className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                                    >
                                        Continue Where I Left Off ‚Üí
                                    </button>
                                </div>
                            )}

                            {hasCompletions && (
                                <div className="bg-white p-4 rounded-lg">
                                    <h4 className="font-semibold text-gray-900 mb-2">Completed Sessions</h4>
                                    <p className="text-gray-700 mb-3">
                                        You have {progressData.completions.length} completed session{progressData.completions.length > 1 ? 's' : ''}
                                    </p>
                                    <button
                                        onClick={onReview}
                                        className="w-full bg-purple-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                                    >
                                        Review Completed Work ‚Üí
                                    </button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Welcome content */}
                    <div className="bg-white rounded-lg shadow-lg p-8">
                        <h2 className="text-3xl font-bold text-gray-900 mb-4">Welcome to Diagnostic Practice</h2>
                        <div className="prose prose-lg">
                            <p className="text-gray-700 mb-4">
                                In this module, you'll develop the practical skill of diagnosing ethical problems 
                                at the right level using the four-level framework:
                            </p>
                            <ul className="space-y-2 text-gray-700 mb-6">
                                <li><strong>Capacity:</strong> Is capacity being suppressed by context?</li>
                                <li><strong>Capability:</strong> Are reliable methods for coordination missing?</li>
                                <li><strong>Constructor:</strong> Do patterns persist or depend on individuals?</li>
                                <li><strong>Meta-Constructor:</strong> Can the system examine and improve itself?</li>
                            </ul>
                            
                            <div className="bg-purple-50 border-l-4 border-purple-500 p-6 mt-6">
                                <h3 className="text-lg font-bold text-purple-900 mb-2">Why Diagnosis Matters</h3>
                                <p className="text-gray-700 text-base">
                                    This isn't just an intellectual exercise. <strong>Misdiagnosis causes real harm:</strong> it 
                                    wastes resources, blames the wrong people, and leaves root causes untouched. Correct diagnosis 
                                    determines what intervention can work and who is responsible for implementing it.
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* What you'll do */}
                    <div className="bg-white rounded-lg shadow-lg p-8">
                        <h3 className="text-2xl font-bold text-gray-900 mb-4">What You'll Do</h3>
                        <div className="space-y-3">
                            <div className="flex items-start">
                                <span className="text-2xl mr-3">üìö</span>
                                <div>
                                    <p className="font-semibold text-gray-900">Tutorial (5-10 minutes)</p>
                                    <p className="text-sm text-gray-600">Quick review of the diagnostic framework</p>
                                </div>
                            </div>
                            <div className="flex items-start">
                                <span className="text-2xl mr-3">üîç</span>
                                <div>
                                    <p className="font-semibold text-gray-900">6 Case Studies (90-120 minutes)</p>
                                    <p className="text-sm text-gray-600">Practice systematic diagnosis with immediate feedback</p>
                                </div>
                            </div>
                            <div className="flex items-start">
                                <span className="text-2xl mr-3">‚ö°</span>
                                <div>
                                    <p className="font-semibold text-gray-900">Pattern Recognition (10 minutes)</p>
                                    <p className="text-sm text-gray-600">Quick-fire practice identifying problem levels</p>
                                </div>
                            </div>
                            <div className="flex items-start">
                                <span className="text-2xl mr-3">üìÑ</span>
                                <div>
                                    <p className="font-semibold text-gray-900">Completion Document</p>
                                    <p className="text-sm text-gray-600">Auto-graded results with 75% accuracy threshold</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Start new session form */}
                    <div className="bg-white rounded-lg shadow-lg p-8">
                        <h3 className="text-2xl font-bold text-gray-900 mb-4">
                            {hasCurrentSession || hasCompletions ? 'Start New Practice Session' : 'Begin Module 2'}
                        </h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Full Name *
                                </label>
                                <input
                                    type="text"
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    placeholder="Enter your full name"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Email Address *
                                </label>
                                <input
                                    type="email"
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    placeholder="your.email@university.edu"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Course/Section *
                                </label>
                                <input
                                    type="text"
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    value={formData.course}
                                    onChange={(e) => setFormData({...formData, course: e.target.value})}
                                    placeholder="e.g., PHIL 101 - Section 02"
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                            >
                                {hasCurrentSession || hasCompletions ? 'Start New Session ‚Üí' : 'Begin Module 2 ‚Üí'}
                            </button>
                        </form>
                        
                        {(hasCurrentSession || hasCompletions) && (
                            <p className="text-sm text-gray-600 mt-4 text-center">
                                This will create a new session with a unique ID. Your previous work is saved.
                            </p>
                        )}
                    </div>
                </div>
            );
        }

        // Completions List Screen (NEW)
        function CompletionsListScreen({ completions, onSelectCompletion, onBack }) {
            const sortedCompletions = [...completions].sort((a, b) => 
                new Date(b.completionTime) - new Date(a.completionTime)
            );

            return (
                <div className="fade-in max-w-4xl mx-auto">
                    <div className="mb-6">
                        <button
                            onClick={onBack}
                            className="text-purple-600 hover:text-purple-700 flex items-center"
                        >
                            ‚Üê Back to Welcome
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-8">
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">Your Completed Sessions</h2>
                        <p className="text-gray-700 mb-6">
                            You have completed {completions.length} practice session{completions.length > 1 ? 's' : ''}. 
                            Click any session to review your work and reasoning.
                        </p>

                        <div className="space-y-4">
                            {sortedCompletions.map((completion, index) => {
                                const overallAccuracy = Math.round(
                                    completion.cases.reduce((sum, c) => sum + c.accuracy, 0) / completion.cases.length
                                );
                                const patternScore = completion.patternRecognition.score;
                                const patternTotal = completion.patternRecognition.answers.length;
                                const finalAccuracy = Math.round(overallAccuracy * 0.9 + (patternScore/patternTotal * 100) * 0.1);
                                const passed = finalAccuracy >= 75;

                                return (
                                    <div
                                        key={completion.sessionId}
                                        onClick={() => onSelectCompletion(completion)}
                                        className="border-2 rounded-lg p-6 cursor-pointer hover:border-purple-500 hover:shadow-lg transition-all"
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 className="text-xl font-bold text-gray-900">
                                                    Session #{sortedCompletions.length - index}
                                                </h3>
                                                <p className="text-sm text-gray-600">
                                                    {completion.studentInfo.name} ‚Ä¢ {completion.studentInfo.course}
                                                </p>
                                                <p className="text-sm text-gray-500">
                                                    Completed: {new Date(completion.completionTime).toLocaleDateString()} at {new Date(completion.completionTime).toLocaleTimeString()}
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <div className={`text-3xl font-bold ${passed ? 'text-green-600' : 'text-yellow-600'}`}>
                                                    {finalAccuracy}%
                                                </div>
                                                <div className={`text-sm font-semibold ${passed ? 'text-green-600' : 'text-yellow-600'}`}>
                                                    {passed ? '‚úì PASSED' : 'Did not pass'}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div className="bg-gray-50 p-3 rounded">
                                                <span className="text-gray-600">Cases:</span>
                                                <span className="ml-2 font-semibold">{completion.cases.length}/6</span>
                                            </div>
                                            <div className="bg-gray-50 p-3 rounded">
                                                <span className="text-gray-600">Pattern Recognition:</span>
                                                <span className="ml-2 font-semibold">{patternScore}/{patternTotal}</span>
                                            </div>
                                        </div>

                                        <p className="text-sm text-gray-500 mt-4">
                                            Session ID: {completion.sessionId}
                                        </p>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // Review Mode Component (NEW)
        function ReviewMode({ completion, onBack }) {
            const [selectedCaseIndex, setSelectedCaseIndex] = useState(0);
            const caseResult = completion.cases[selectedCaseIndex];
            const caseData = CASES.find(c => c.id === caseResult.caseId);
            const expertScores = EXPERT_DIAGNOSES[caseResult.caseId];

            const overallAccuracy = Math.round(
                completion.cases.reduce((sum, c) => sum + c.accuracy, 0) / completion.cases.length
            );
            const patternScore = completion.patternRecognition.score;
            const patternTotal = completion.patternRecognition.answers.length;
            const finalAccuracy = Math.round(overallAccuracy * 0.9 + (patternScore/patternTotal * 100) * 0.1);

            const downloadPDF = () => {
                const doc = generateCompletionDocument(completion);
                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Module 2 Completion Document - ${completion.studentInfo.name}</title>
                        <style>
                            body { font-family: 'Courier New', monospace; padding: 20px; font-size: 12px; line-height: 1.4; }
                            pre { white-space: pre-wrap; }
                        </style>
                    </head>
                    <body>
                        <pre>${doc}</pre>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 250);
            };

            const copyToClipboard = () => {
                const doc = generateCompletionDocument(completion);
                navigator.clipboard.writeText(doc);
                alert('Completion document copied to clipboard!');
            };

            return (
                <div className="fade-in max-w-5xl mx-auto">
                    <div className="mb-6">
                        <button
                            onClick={onBack}
                            className="text-purple-600 hover:text-purple-700 flex items-center"
                        >
                            ‚Üê Back to Completions List
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                        <h2 className="text-3xl font-bold text-gray-900 mb-4">Review: Session {completion.sessionId}</h2>
                        
                        <div className="bg-purple-50 p-6 rounded-lg mb-6">
                            <div className="grid md:grid-cols-3 gap-4">
                                <div>
                                    <div className="text-sm text-gray-600">Student</div>
                                    <div className="font-semibold">{completion.studentInfo.name}</div>
                                </div>
                                <div>
                                    <div className="text-sm text-gray-600">Completed</div>
                                    <div className="font-semibold">{new Date(completion.completionTime).toLocaleDateString()}</div>
                                </div>
                                <div>
                                    <div className="text-sm text-gray-600">Final Accuracy</div>
                                    <div className="text-2xl font-bold text-purple-700">{finalAccuracy}%</div>
                                </div>
                            </div>
                        </div>

                        <div className="flex space-x-3 mb-6">
                            <button
                                onClick={downloadPDF}
                                className="flex-1 bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center"
                            >
                                <span className="mr-2">üìÑ</span> Download Document
                            </button>
                            <button
                                onClick={copyToClipboard}
                                className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-300 transition-colors flex items-center justify-center"
                            >
                                <span className="mr-2">üìã</span> Copy to Clipboard
                            </button>
                        </div>

                        <div className="border-t pt-6">
                            <h3 className="text-xl font-bold text-gray-900 mb-4">Navigate Cases</h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                                {completion.cases.map((caseRes, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => setSelectedCaseIndex(idx)}
                                        className={`p-3 rounded-lg text-left transition-all ${
                                            selectedCaseIndex === idx
                                                ? 'bg-purple-600 text-white shadow-lg'
                                                : 'bg-gray-100 hover:bg-gray-200'
                                        }`}
                                    >
                                        <div className="font-semibold">Case {idx + 1}</div>
                                        <div className="text-sm opacity-90">{caseRes.accuracy}% accuracy</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Selected Case Review */}
                    <div className="bg-white rounded-lg shadow-lg p-8">
                        <h3 className="text-2xl font-bold text-gray-900 mb-4">
                            Case {selectedCaseIndex + 1}: {caseData.title}
                        </h3>

                        <div className="bg-gray-50 p-6 rounded-lg mb-6">
                            <h4 className="font-semibold text-gray-900 mb-2">Scenario:</h4>
                            <p className="text-gray-700 text-sm whitespace-pre-line">{caseData.scenario.substring(0, 300)}...</p>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h4 className="font-semibold text-gray-900 mb-3">Your Diagnosis</h4>
                                {['capacity', 'capability', 'constructor', 'metaConstructor'].map(level => {
                                    const labels = {
                                        capacity: 'Capacity',
                                        capability: 'Capability',
                                        constructor: 'Constructor',
                                        metaConstructor: 'Meta-Constructor'
                                    };
                                    return (
                                        <div key={level} className="mb-3">
                                            <div className="flex justify-between mb-1">
                                                <span className="text-sm">{labels[level]}</span>
                                                <span className="font-bold text-purple-700">{caseResult.studentScores[level]}%</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-4">
                                                <div 
                                                    className="score-bar h-4"
                                                    style={{width: `${caseResult.studentScores[level]}%`}}
                                                ></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            <div>
                                <h4 className="font-semibold text-gray-900 mb-3">Expert Diagnosis</h4>
                                {['capacity', 'capability', 'constructor', 'metaConstructor'].map(level => {
                                    const labels = {
                                        capacity: 'Capacity',
                                        capability: 'Capability',
                                        constructor: 'Constructor',
                                        metaConstructor: 'Meta-Constructor'
                                    };
                                    const diff = Math.abs(caseResult.studentScores[level] - expertScores[level]);
                                    return (
                                        <div key={level} className="mb-3">
                                            <div className="flex justify-between mb-1">
                                                <span className="text-sm">{labels[level]}</span>
                                                <div>
                                                    <span className="font-bold mr-2">{expertScores[level]}%</span>
                                                    <span className={diff <= 10 ? 'text-green-600' : diff <= 20 ? 'text-yellow-600' : 'text-red-600'}>
                                                        {diff <= 10 ? '‚úì' : diff <= 20 ? '‚ö†' : '‚úó'}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-4">
                                                <div 
                                                    className="bg-gray-600 h-4 rounded-full"
                                                    style={{width: `${expertScores[level]}%`}}
                                                ></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {caseResult.reasoning && (
                            <div className="bg-blue-50 p-6 rounded-lg mb-6">
                                <h4 className="font-semibold text-blue-900 mb-2">Your Reasoning:</h4>
                                <p className="text-gray-700 whitespace-pre-line">{caseResult.reasoning}</p>
                            </div>
                        )}

                        <div className="bg-purple-50 p-6 rounded-lg">
                            <h4 className="font-semibold text-purple-900 mb-2">Expert Explanation:</h4>
                            <p className="text-gray-700 mb-4">{expertScores.explanation}</p>
                            <div className="bg-yellow-100 p-4 rounded border-l-4 border-yellow-500">
                                <h5 className="font-semibold text-yellow-900 mb-1">Common Mistake:</h5>
                                <p className="text-gray-700 text-sm">{expertScores.commonMistake}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Helper function to generate completion document
        function generateCompletionDocument(completion) {
            const overallAccuracy = Math.round(
                completion.cases.reduce((sum, c) => sum + c.accuracy, 0) / completion.cases.length
            );
            const patternScore = completion.patternRecognition.score;
            const patternTotal = completion.patternRecognition.answers.length;
            const patternPercentage = Math.round((patternScore / patternTotal) * 100);
            const finalAccuracy = Math.round(overallAccuracy * 0.9 + patternPercentage * 0.1);
            const passed = finalAccuracy >= 75;

            const skillLevels = {
                capacity: determineSkillLevel(
                    Math.round(completion.cases.reduce((sum, c) => {
                        return sum + (100 - Math.abs(c.studentScores.capacity - c.expertScores.capacity));
                    }, 0) / completion.cases.length)
                ),
                capability: determineSkillLevel(
                    Math.round(completion.cases.reduce((sum, c) => {
                        return sum + (100 - Math.abs(c.studentScores.capability - c.expertScores.capability));
                    }, 0) / completion.cases.length)
                ),
                constructor: determineSkillLevel(
                    Math.round(completion.cases.reduce((sum, c) => {
                        return sum + (100 - Math.abs(c.studentScores.constructor - c.expertScores.constructor));
                    }, 0) / completion.cases.length)
                ),
                metaConstructor: determineSkillLevel(
                    Math.round(completion.cases.reduce((sum, c) => {
                        return sum + (100 - Math.abs(c.studentScores.metaConstructor - c.expertScores.metaConstructor));
                    }, 0) / completion.cases.length)
                )
            };

            return `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    MODULE 2: DIAGNOSTIC PRACTICE
    Completion Document
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Student Information:
  Name:           ${completion.studentInfo.name}
  Email:          ${completion.studentInfo.email}
  Course:         ${completion.studentInfo.course}

Completion Details:
  Completed:      ${new Date(completion.completionTime).toLocaleString()}
  Session ID:     ${completion.sessionId}
  Started:        ${new Date(completion.startTime).toLocaleString()}
  Total Time:     ${Math.round((new Date(completion.completionTime) - new Date(completion.startTime)) / 60000)} minutes

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PERFORMANCE SUMMARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Overall Accuracy:      ${finalAccuracy}%
Required Threshold:    75%
Status:               ${passed ? '‚úì PASSED' : '‚úó DID NOT PASS'}

Cases Completed:       ${completion.cases.length}/${CASES.length}
Case Avg Accuracy:     ${overallAccuracy}%
Pattern Recognition:   ${patternScore}/${patternTotal} correct (${patternPercentage}%)

Diagnostic Skill Assessment:
  Capacity Diagnosis:        ${skillLevels.capacity}
  Capability Diagnosis:      ${skillLevels.capability}
  Constructor Diagnosis:     ${skillLevels.constructor}
  Meta-Constructor Diagnosis: ${skillLevels.metaConstructor}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CASE-BY-CASE BREAKDOWN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${completion.cases.map((caseResult, idx) => {
    const caseData = CASES.find(c => c.id === caseResult.caseId);
    return `
CASE ${idx + 1}: ${caseResult.title}
  Accuracy: ${caseResult.accuracy}%
  Primary Diagnosis: ${caseResult.studentScores.primary === caseResult.expertScores.primary ? '‚úì Correct' : '‚úó Incorrect'}
  
  Student Assessment:
    Capacity:         ${caseResult.studentScores.capacity}% (Expert: ${caseResult.expertScores.capacity}%)  Œî ${Math.abs(caseResult.studentScores.capacity - caseResult.expertScores.capacity)}%
    Capability:       ${caseResult.studentScores.capability}% (Expert: ${caseResult.expertScores.capability}%)  Œî ${Math.abs(caseResult.studentScores.capability - caseResult.expertScores.capability)}%
    Constructor:      ${caseResult.studentScores.constructor}% (Expert: ${caseResult.expertScores.constructor}%)  Œî ${Math.abs(caseResult.studentScores.constructor - caseResult.expertScores.constructor)}%
    Meta-Constructor: ${caseResult.studentScores.metaConstructor}% (Expert: ${caseResult.expertScores.metaConstructor}%)  Œî ${Math.abs(caseResult.studentScores.metaConstructor - caseResult.expertScores.metaConstructor)}%
  
  ${caseResult.reasoning ? `Brief Reasoning Provided:\n  "${caseResult.reasoning.replace(/\n/g, '\n  ')}"\n` : 'No reasoning provided.\n'}
  Time Spent: ${Math.round((new Date(caseResult.endTime) - new Date(caseResult.startTime)) / 60000)} minutes

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`;
}).join('\n')}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
VERIFICATION & INTEGRITY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

This completion document was automatically generated by
the Ethical Design Diagnostic Practice Module 2.

Document Generated: ${new Date().toLocaleString()}
Unique Session ID:  ${completion.sessionId}
Version:           Module 2 v1.0 Enhanced

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
End of Completion Document
`;
        }

        // Keep all other components (Tutorial, Responsibility, CaseWorkflow, etc.) the same as before
        // For brevity, I'll include just the key ones here and note that the rest continue...

        // Tutorial Screen (same as before)
        function TutorialScreen({ onComplete }) {
            return (
                <div className="fade-in max-w-3xl mx-auto">
                    <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">The Diagnostic Framework</h2>
                        <p className="text-gray-700 mb-6">
                            Quick review of the four levels before you begin practice...
                        </p>
                        <button
                            onClick={onComplete}
                            className="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                        >
                            Continue: Why Diagnosis Matters ‚Üí
                        </button>
                    </div>
                </div>
            );
        }

        // Responsibility Screen (placeholder - use the full one from before)
        function ResponsibilityScreen({ onComplete }) {
            return (
                <div className="fade-in max-w-4xl mx-auto">
                    <div className="bg-white rounded-lg shadow-lg p-8">
                        <h2 className="text-3xl font-bold text-gray-900 mb-4">Why Diagnosis Matters</h2>
                        <p className="text-gray-700 mb-6">
                            [Full content from previous version goes here...]
                        </p>
                        <button
                            onClick={onComplete}
                            className="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                        >
                            Start Case Studies ‚Üí
                        </button>
                    </div>
                </div>
            );
        }

        // CaseWorkflow, DiagnosePhase, ReviewPhase, PatternRecognitionGame (all same as before)
        // CompletionScreen needs updating to add "Start New" and "Review" buttons

        function CaseWorkflow({ caseData, caseNumber, totalCases, onComplete }) {
            // ... (same implementation as before)
            return <div>Case workflow here...</div>;
        }

        function PatternRecognitionGame({ questions, onComplete }) {
            // ... (same implementation as before)
            return <div>Pattern recognition here...</div>;
        }

        // Updated Completion Screen
        function CompletionScreen({ completion, onStartNew, onReview }) {
            const overallAccuracy = Math.round(
                completion.cases.reduce((sum, c) => sum + c.accuracy, 0) / completion.cases.length
            );
            const patternScore = completion.patternRecognition.score;
            const patternTotal = completion.patternRecognition.answers.length;
            const finalAccuracy = Math.round(overallAccuracy * 0.9 + (patternScore/patternTotal * 100) * 0.1);
            const passed = finalAccuracy >= 75;

            const downloadPDF = () => {
                const doc = generateCompletionDocument(completion);
                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Module 2 Completion - ${completion.studentInfo.name}</title>
                        <style>
                            body { font-family: 'Courier New', monospace; padding: 20px; font-size: 12px; }
                            pre { white-space: pre-wrap; }
                        </style>
                    </head>
                    <body><pre>${doc}</pre></body>
                    </html>
                `);
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 250);
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(generateCompletionDocument(completion));
                alert('Document copied!');
            };

            return (
                <div className="fade-in max-w-3xl mx-auto space-y-6">
                    <div className={`rounded-lg shadow-lg p-8 ${
                        passed ? 'bg-green-50 border-2 border-green-500' : 'bg-yellow-50 border-2 border-yellow-500'
                    }`}>
                        <h2 className="text-3xl font-bold text-gray-900 mb-4">
                            {passed ? 'üéâ Congratulations!' : '‚ö†Ô∏è Not Quite There'}
                        </h2>
                        <p className="text-lg text-gray-700 mb-6">
                            Final Accuracy: <strong className="text-purple-700">{finalAccuracy}%</strong>
                        </p>
                    </div>

                    {passed && (
                        <div className="bg-white rounded-lg shadow-lg p-8">
                            <h3 className="text-2xl font-bold mb-4">Download Your Completion Document</h3>
                            <div className="space-y-3">
                                <button onClick={downloadPDF} className="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700">
                                    üìÑ Download as PDF
                                </button>
                                <button onClick={copyToClipboard} className="w-full bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300">
                                    üìã Copy to Clipboard
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-lg shadow-lg p-8">
                        <h3 className="text-xl font-bold mb-4">What's Next?</h3>
                        <div className="space-y-3">
                            <button
                                onClick={onReview}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center"
                            >
                                <span className="mr-2">üìã</span> Review Your Work
                            </button>
                            <button
                                onClick={onStartNew}
                                className="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 flex items-center justify-center"
                            >
                                <span className="mr-2">üîÑ</span> Practice Again (New Session)
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
